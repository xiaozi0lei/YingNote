Tag.classes={"蓝色":"label label-blue","红色":"label label-red","绿色":"label label-green","黄色":"label label-yellow",blue:"label label-blue",red:"label label-red",green:"label label-green",yellow:"label label-yellow"};Tag.mapCn2En={"蓝色":"blue","红色":"red","绿色":"green","黄色":"yellow"};Tag.mapEn2Cn={blue:"蓝色",red:"红色",green:"绿色",yellow:"黄色"};Tag.t=$("#tags");Tag.getTags=function(){var tags=[];Tag.t.children().each(function(){var text=$(this).data("tag");text=Tag.mapCn2En[text]||text;tags.push(text)});return tags};Tag.clearTags=function(){Tag.t.html("")};Tag.renderTags=function(tags){Tag.t.html("");if(isEmpty(tags)){return}for(var i=0;i<tags.length;++i){var tag=tags[i];Tag.appendTag(tag)}};function revertTagStatus(){$("#addTagTrigger").show();$("#addTagInput").hide()}function hideTagList(event){$("#tagDropdown").removeClass("open");if(event){event.stopPropagation()}}function showTagList(event){$("#tagDropdown").addClass("open");if(event){event.stopPropagation()}}Tag.renderReadOnlyTags=function(tags){$("#noteReadTags").html("");if(isEmpty(tags)||tags.length==1&&tags[0]==""){$("#noteReadTags").html(getMsg("noTag"))}var i=true;function getNextDefaultClasses(){if(i){return"label label-default";i=false}else{i=true;return"label label-info"}}for(var i in tags){var text=tags[i];text=Tag.mapEn2Cn[text]||text;var classes=Tag.classes[text];if(!classes){classes=getNextDefaultClasses()}tag=tt('<span class="?">?</span>',classes,text);$("#noteReadTags").append(tag)}};Tag.appendTag=function(tag,save){var isColor=false;var classes,text;if(typeof tag=="object"){classes=tag.classes;text=tag.text;if(!text){return}}else{tag=$.trim(tag);text=tag;if(!text){return}var classes=Tag.classes[text];if(classes){isColor=true}else{classes="label label-default"}}var rawText=text;if(LEA.locale=="zh"){text=Tag.mapEn2Cn[text]||text;rawText=Tag.mapCn2En[rawText]||rawText}tag=tt('<span class="?" data-tag="?">?<i title="'+getMsg("delete")+'">X</i></span>',classes,text,text);var isExists=false;$("#tags").children().each(function(){if(isColor){var tagHtml=$("<div></div>").append($(this).clone()).html();if(tagHtml==tag){$(this).remove();isExists=true}}else if(text+"X"==$(this).text()){$(this).remove();isExists=true}});$("#tags").append(tag);hideTagList();if(!isColor){reRenderTags()}if(save){Note.curNoteIsDirtied();if(!isExists){Note.curChangedSaveIt(true,function(){ajaxPost("/tag/updateTag",{tag:rawText},function(ret){if(reIsOk(ret)){Tag.addTagNav(ret.Item)}})})}}};function reRenderTags(){var defautClasses=["label label-default","label label-info"];var i=0;$("#tags").children().each(function(){var thisClasses=$(this).attr("class");if(thisClasses=="label label-default"||thisClasses=="label label-info"){$(this).removeClass(thisClasses).addClass(defautClasses[i%2]);i++}})}Tag.removeTag=function($target){var tag=$target.data("tag");$target.remove();reRenderTags();if(LEA.locale=="zh"){tag=Tag.mapCn2En[tag]||tag}Note.curChangedSaveIt(true,function(){ajaxPost("/tag/updateTag",{tag:tag},function(ret){if(reIsOk(ret)){Tag.addTagNav(ret.Item)}})})};Tag.tags=[];Tag.renderTagNav=function(tags){var me=this;tags=tags||[];Tag.tags=tags;$("#tagNav").html("");for(var i in tags){var noteTag=tags[i];var tag=noteTag.Tag;var text=tag;if(LEA.locale=="zh"){var text=Tag.mapEn2Cn[tag]||text}var classes=Tag.classes[tag]||"label label-default";$("#tagNav").append(tt('<li data-tag="?"><a> <span class="?">?</span> <span class="tag-delete">X</span></li>',tag,classes,text))}};Tag.addTagNav=function(newTag){var me=this;for(var i in me.tags){var noteTag=me.tags[i];if(noteTag.Tag==newTag.Tag){me.tags.splice(i,1);break}}me.tags.unshift(newTag);me.renderTagNav(me.tags)};$(function(){$("#addTagTrigger").click(function(){$(this).hide();$("#addTagInput").show().focus().val("")});$("#addTagInput").click(function(event){showTagList(event)});$("#addTagInput").blur(function(){var val=$(this).val();if(val){Tag.appendTag(val,true)}return;$("#addTagTrigger").show();$("#addTagInput").hide()});$("#addTagInput").keydown(function(e){if(e.keyCode==13){hideTagList();if($("#addTagInput").val()){$(this).trigger("blur");$("#addTagTrigger").trigger("click")}else{$(this).trigger("blur")}}});$("#tagColor li").click(function(event){var a;if($(this).attr("role")){a=$(this).find("span")}else{a=$(this)}Tag.appendTag({classes:a.attr("class"),text:a.text()},true)});$("#tags").on("click","i",function(){Tag.removeTag($(this).parent())});function deleteTag(){$li=$(this).closest("li");var tag=$.trim($li.data("tag"));if(confirm("Are you sure ?")){ajaxPost("/tag/deleteTag",{tag:tag},function(re){if(reIsOk(re)){var item=re.Item;Note.deleteNoteTag(item,tag);$li.remove()}})}}function searchTag(){var $li=$(this).closest("li");var tag=$.trim($li.data("tag"));Note.curChangedSaveIt();Note.clearAll();$("#tagSearch").html($li.html()).show();$("#tagSearch .tag-delete").remove();showLoading();ajaxGet("/note/searchNoteByTags",{tags:[tag]},function(notes){hideLoading();if(notes){Note.renderNotes(notes);if(!isEmpty(notes)){Note.changeNote(notes[0].NoteId)}}})}$("#myTag .folderBody").on("click","li .label",searchTag);$("#myTag .folderBody").on("click","li .tag-delete",deleteTag)});